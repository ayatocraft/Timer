<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0078d7" />
<title>Full Clock Tool</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #fff;
    color: #000;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  body.dark {
    background: #121212;
    color: #fff;
  }
  button {
    cursor: pointer;
    font-family: inherit;
    font-size: 1rem;
  }
  button:disabled {
    opacity: 0.5;
    cursor: default;
  }
  nav.tabs {
    display: flex;
    flex-direction: column;
    background: #f0f0f0;
    border-right: 1px solid #ccc;
    width: 240px;
    transition: width 0.3s ease;
  }
  body.dark nav.tabs {
    background: #222;
    border-color: #444;
  }
  nav.tabs.hidden {
    display: none;
  }
  nav.tabs button.tab {
    background: none;
    border: none;
    padding: 1rem 1.5rem;
    text-align: left;
    border-bottom: 1px solid #ccc;
    color: inherit;
  }
  body.dark nav.tabs button.tab {
    border-color: #444;
  }
  nav.tabs button.tab.active {
    background: #0078d7;
    color: white;
    font-weight: bold;
  }
  nav.tabs button.tab:focus-visible {
    outline: 2px solid #0078d7;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1rem;
    height: 44px;
    background: #0078d7;
    color: #fff;
    flex-shrink: 0;
  }
  #toggleTabsBtn {
    background: none;
    border: none;
    font-size: 1.6rem;
    color: white;
  }
  #toggleTabsBtn:focus-visible {
    outline: 2px solid #fff;
  }
  main {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
  }
  section.content {
    display: none;
  }
  section.content.active {
    display: block;
  }
  h1 {
    margin-top: 0;
  }
  /* Current time/date centered on home */
  /* These styles now apply to the elements within the #home section */
  #currentTime, #currentDate {
    line-height: 1.2;
    text-align: center;
    user-select: none;
    font-weight: bold;
  }
  #currentTime {
    font-size: 1.8rem;
  }
  #currentDate {
    font-size: 1.2rem;
    opacity: 0.8;
  }
  /* Input groups */
  .input-group {
    margin: 0.5rem 0;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  input[type=number], input[type=text], textarea, select {
    font-family: inherit;
    font-size: 1rem;
    padding: 0.3rem 0.5rem;
    border: 1px solid #ccc;
    border-radius: 3px;
    flex-grow: 1;
  }
  body.dark input[type=number], body.dark input[type=text], body.dark textarea, body.dark select {
    background: #222;
    border-color: #555;
    color: #eee;
  }
  textarea {
    resize: vertical;
    min-height: 6rem;
  }
  label {
    font-weight: normal;
    user-select: none;
  }
  /* Timers */
  #timersList, #timerHistory, #alarmList, #lapList {
    margin-top: 0.5rem;
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 0.5rem;
    background: #fafafa;
    color: #000;
  }
  body.dark #timersList, body.dark #timerHistory, body.dark #alarmList, body.dark #lapList {
    background: #222;
    border-color: #444;
    color: #fff;
  }
  .timer-item, .alarm-item, .lap-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.3rem;
    padding: 0.3rem;
    border-bottom: 1px solid #ddd;
  }
  body.dark .timer-item, body.dark .alarm-item, body.dark .lap-item {
    border-color: #444;
  }
  .timer-item:last-child, .alarm-item:last-child, .lap-item:last-child {
    border-bottom: none;
  }
  .timer-item span, .alarm-item span {
    flex-shrink: 0;
  }
  .timer-controls button, .alarm-item button {
    margin-left: 0.3rem;
  }
  /* Progress bar */
  .timer-progress {
    flex-grow: 1;
    margin: 0 0.5rem;
    background: #ddd;
    border-radius: 3px;
    height: 12px;
    overflow: hidden;
  }
  body.dark .timer-progress {
    background: #444;
  }
  .progress-bar {
    background: #0078d7;
    height: 100%;
    transition: width 0.4s linear;
  }
  /* Stopwatch */
  #stopwatchDisplay {
    font-size: 2rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 0.5rem;
  }
  /* Accessibility */
  [tabindex="0"]:focus {
    outline: 2px solid #0078d7;
  }
</style>
</head>
<body>
<nav class="tabs" aria-label="メインナビゲーション">
  <button id="tab-home" class="tab active" role="tab" aria-selected="true" tabindex="0">ホーム</button>
  <button id="tab-timer" class="tab" role="tab" aria-selected="false" tabindex="-1">タイマー</button>
  <button id="tab-alarm" class="tab" role="tab" aria-selected="false" tabindex="-1">アラーム</button>
  <button id="tab-stopwatch" class="tab" role="tab" aria-selected="false" tabindex="-1">ストップウォッチ</button>
  <button id="tab-settings" class="tab" role="tab" aria-selected="false" tabindex="-1">設定</button>
</nav>

<div style="flex-grow:1; display:flex; flex-direction:column;">
<header>
  <button id="toggleTabsBtn" aria-label="タブの表示切替" aria-expanded="true">≡</button>
</header>

<main>
  <section id="home" class="content active" role="tabpanel" aria-labelledby="tab-home" tabindex="0">
    <h1>ホーム</h1>
    <div id="currentTime" aria-label="現在時刻"></div>
    <div id="currentDate" aria-label="現在日付"></div>
  </section>

  <section id="timer" class="content" role="tabpanel" aria-labelledby="tab-timer" tabindex="-1">
    <h1>タイマー</h1>
    <form id="timerForm" aria-label="タイマー追加フォーム">
      <div class="input-group">
        <input type="text" id="timerLabel" placeholder="ラベル（任意）" aria-label="タイマーラベル" />
      </div>
      <div class="input-group" style="gap: 0.2rem;">
        <label for="timerMinutes">分</label>
        <input type="number" id="timerMinutes" min="0" max="999" value="0" aria-label="分" />
        <label for="timerSeconds">秒</label>
        <input type="number" id="timerSeconds" min="0" max="59" value="10" aria-label="秒" />
      </div>
      <div class="input-group">
        <button type="submit">追加して開始</button>
      </div>
    </form>
    <div id="timersList" aria-live="polite" aria-atomic="true"></div>
    <h2>タイマー履歴</h2>
    <div id="timerHistory" aria-live="polite" aria-atomic="true" tabindex="0"></div>
  </section>

  <section id="alarm" class="content" role="tabpanel" aria-labelledby="tab-alarm" tabindex="-1">
    <h1>アラーム</h1>
    <form id="alarmForm" aria-label="アラーム追加フォーム">
      <div class="input-group" style="gap: 0.2rem;">
        <label for="alarmHour">時</label>
        <input type="number" id="alarmHour" min="0" max="23" placeholder="00" aria-label="時" />
        <label for="alarmMinute">分</label>
        <input type="number" id="alarmMinute" min="0" max="59" placeholder="00" aria-label="分" />
        <label for="alarmSecond">秒</label>
        <input type="number" id="alarmSecond" min="0" max="59" placeholder="00" aria-label="秒" value="0" />
      </div>
      <div class="input-group">
        <input type="text" id="alarmLabel" placeholder="ラベル（任意）" aria-label="アラームラベル" />
      </div>
      <div class="input-group">
        <button type="submit">追加</button>
      </div>
    </form>
    <div id="alarmList" aria-live="polite" aria-atomic="true"></div>
  </section>

  <section id="stopwatch" class="content" role="tabpanel" aria-labelledby="tab-stopwatch" tabindex="-1">
    <h1>ストップウォッチ</h1>
    <div id="stopwatchDisplay" aria-live="polite" aria-atomic="true">00:00:00.000</div>
    <div class="input-group" role="group" aria-label="ストップウォッチ操作ボタン">
      <button id="startStopwatchBtn">開始</button>
      <button id="pauseStopwatchBtn" disabled>一時停止</button>
      <button id="resetStopwatchBtn" disabled>リセット</button>
      <button id="lapStopwatchBtn" disabled>ラップ</button>
    </div>
    <div id="lapList" aria-live="polite" aria-label="ラップタイム一覧" tabindex="0"></div>
  </section>

  <section id="settings" class="content" role="tabpanel" aria-labelledby="tab-settings" tabindex="-1">
    <h1>設定</h1>
    <fieldset>
      <legend>テーマ</legend>
      <div class="input-group" role="radiogroup" aria-label="テーマ切替">
        <label><input type="radio" name="theme" value="light" /> ライト</label>
        <label><input type="radio" name="theme" value="dark" /> ダーク</label>
      </div>
    </fieldset>

    <fieldset>
      <legend>PWA インストール</legend>
      <div class="input-group">
        <button id="installPwaBtn" disabled style="background:#0078d7;color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;">
          アプリをインストール
        </button>
      </div>
    </fieldset>
    <fieldset>
      <legend>About</legend>
      <p>バージョン: build 25.11.12</p>
    </fieldset>
    <fieldset>
      <legend>タイマー音設定</legend>
      <div class="input-group">
        <select id="timerSoundSelect" aria-label="タイマー音選択">
          <option value="digital_alarm">デジタルアラーム</option>
          <option value="alarm_clock">目覚まし時計</option>
          <option value="chime">チャイム</option>
          <option value="none">なし</option>
        </select>
      </div>
    </fieldset>
    <fieldset>
      <legend>アラーム音設定</legend>
      <div class="input-group">
        <select id="alarmSoundSelect" aria-label="アラーム音選択">
          <option value="pager_alert">ページャーアラート</option>
          <option value="siren">サイレン</option>
          <option value="chime">チャイム</option>
          <option value="none">なし</option>
        </select>
      </div>
    </fieldset>
    <div style="margin-top:1rem;">
      <button id="clearAllHistoryBtn" style="background:#c33;color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;">履歴全削除</button>
    </div>
  </section>
</main>
</div>

<audio id="timerAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" type="audio/ogg" />
  <source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.mp3" type="audio/mpeg" />
</audio>
<audio id="alarmAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/fire_pager_alert.ogg" type="audio/ogg" />
  <source src="https://actions.google.com/sounds/v1/alarms/fire_pager_alert.mp3" type="audio/mpeg" />
</audio>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        })
        .catch(err => {
          console.log('ServiceWorker registration failed: ', err);
        });
    });
  }
</script>

<script>
(() => {
  // --- タブ管理 ---
  const tabs = document.querySelectorAll('nav.tabs button.tab');
  const contents = document.querySelectorAll('main section.content');
  const toggleTabsBtn = document.getElementById('toggleTabsBtn');
  const navTabs = document.querySelector('nav.tabs');
  const currentTimeElem = document.getElementById('currentTime');
  const currentDateElem = document.getElementById('currentDate');

  function showTab(id, clickedTab=null) {
    contents.forEach(section => {
      if (section.id === id) {
        section.classList.add('active');
        section.setAttribute('tabindex', '0');
      } else {
        section.classList.remove('active');
        section.setAttribute('tabindex', '-1');
      }
    });
    tabs.forEach(tab => {
      const selected = tab.id === 'tab-' + id;
      tab.classList.toggle('active', selected);
      tab.setAttribute('aria-selected', selected.toString());
      tab.tabIndex = selected ? 0 : -1;
    });
    
    if (clickedTab) clickedTab.focus();
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', e => {
      e.preventDefault();
      showTab(tab.id.replace('tab-',''), tab);
    });
    tab.addEventListener('keydown', e => {
      let idx = Array.from(tabs).indexOf(e.target);
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        let next = (idx + 1) % tabs.length;
        tabs[next].focus();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        let prev = (idx - 1 + tabs.length) % tabs.length;
        tabs[prev].focus();
      }
    });
  });

  // --- タブ表示・非表示切替 ---
  let tabsVisible = true;
  toggleTabsBtn.addEventListener('click', () => {
    tabsVisible = !tabsVisible;
    if (tabsVisible) {
      navTabs.classList.remove('hidden');
      toggleTabsBtn.setAttribute('aria-expanded', 'true');
    } else {
      navTabs.classList.add('hidden');
      toggleTabsBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // --- 日付と時刻表示 ---
  const WEEK_DAYS_JP = ['日', '月', '火', '水', '木', '金', '土'];

  function padZero(num, len = 2) {
    return String(num).padStart(len, '0');
  }

  function updateDateTime() {
    const now = new Date();
    currentTimeElem.textContent = `${padZero(now.getHours())}:${padZero(now.getMinutes())}:${padZero(now.getSeconds())}`;
    currentDateElem.textContent = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日（${WEEK_DAYS_JP[now.getDay()]}）`;
  }

  updateDateTime();
  setInterval(updateDateTime, 1000);

  // --- 通知機能 ---
  function showNotification(title, body, audioElem) {
    // 最初に音を鳴らす
    if (audioElem && audioElem.src && audioElem.src !== '') {
      audioElem.play().catch(e => console.error("Audio play failed:", e));
    }

    if (!('Notification' in window)) {
      // 通知がサポートされていない
      alert(title + "\n" + body);
      return;
    }

    if (Notification.permission === 'granted') {
      // 許可されている
      new Notification(title, { body: body });
    } else if (Notification.permission !== 'denied') {
      // 'default' (または 'denied' ではない何か)
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          new Notification(title, { body: body });
        } else {
          // 許可されなかったのでアラート
          alert(title + "\n" + body);
        }
      });
    } else {
      // 'denied' されている
      alert(title + "\n" + body);
    }
  }

  // --- テーマ切替 ---
  const themeRadios = document.querySelectorAll('input[name="theme"]');
  function applyTheme(theme) {
    if (theme === 'dark') {
      document.body.classList.add('dark');
    } else {
      document.body.classList.remove('dark');
    }
    localStorage.setItem('theme', theme);
  }
  function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);
    themeRadios.forEach(radio => {
      radio.checked = radio.value === savedTheme;
      radio.addEventListener('change', e => {
        applyTheme(e.target.value);
      });
    });
  }
  initTheme();

  // --- 音設定 ---
  const timerSoundSelect = document.getElementById('timerSoundSelect');
  const alarmSoundSelect = document.getElementById('alarmSoundSelect');
  const timerAudio = document.getElementById('timerAudio');
  const alarmAudio = document.getElementById('alarmAudio');

  function updateTimerAudio() {
    const val = timerSoundSelect.value;
    switch(val) {
      case 'digital_alarm':
        timerAudio.src = "https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg";
        break;
      case 'alarm_clock':
        timerAudio.src = "https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg";
        break;
      case 'chime':
        timerAudio.src = "https://actions.google.com/sounds/v1/alarms/chime.ogg";
        break;
      case 'none':
      default:
        timerAudio.src = "";
        break;
    }
    timerAudio.load();
  }
  function updateAlarmAudio() {
    const val = alarmSoundSelect.value;
    switch(val) {
      case 'pager_alert':
        alarmAudio.src = "https://actions.google.com/sounds/v1/alarms/fire_pager_alert.ogg";
        break;
      case 'siren':
        alarmAudio.src = "https://actions.google.com/sounds/v1/alarms/emergency_siren_short.ogg";
        break;
      case 'chime':
        alarmAudio.src = "https://actions.google.com/sounds/v1/alarms/chime.ogg";
        break;
      case 'none':
      default:
        alarmAudio.src = "";
        break;
    }
    alarmAudio.load();
  }
  function initSoundSettings() {
    // 新しいデフォルト値
    const savedTimerSound = localStorage.getItem('timerSound') || 'digital_alarm';
    const savedAlarmSound = localStorage.getItem('alarmSound') || 'pager_alert';
    timerSoundSelect.value = savedTimerSound;
    alarmSoundSelect.value = savedAlarmSound;
    updateTimerAudio();
    updateAlarmAudio();

    timerSoundSelect.addEventListener('change', () => {
      localStorage.setItem('timerSound', timerSoundSelect.value);
      updateTimerAudio();
    });
    alarmSoundSelect.addEventListener('change', () => {
      localStorage.setItem('alarmSound', alarmSoundSelect.value);
      updateAlarmAudio();
    });
  }
  initSoundSettings();

  // --- タイマー機能 ---
  let timers = JSON.parse(localStorage.getItem('timers') || '[]');
  let timerHistory = JSON.parse(localStorage.getItem('timerHistory') || '[]');

  const timerForm = document.getElementById('timerForm');
  const timerLabelInput = document.getElementById('timerLabel');
  const timerMinutesInput = document.getElementById('timerMinutes');
  const timerSecondsInput = document.getElementById('timerSeconds');
  const timersList = document.getElementById('timersList');
  const timerHistoryElem = document.getElementById('timerHistory');

  function saveTimers() {
    localStorage.setItem('timers', JSON.stringify(timers));
  }
  function saveTimerHistory() {
    localStorage.setItem('timerHistory', JSON.stringify(timerHistory));
  }
  function formatTimeSec(s) {
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return `${m}分${sec}秒`;
  }
  function renderTimers() {
    timersList.innerHTML = '';
    if (timers.length === 0) {
      timersList.textContent = 'タイマーはありません。';
      return;
    }
    timers.forEach((timer, i) => {
      const div = document.createElement('div');
      div.className = 'timer-item';
      div.setAttribute('aria-live', 'polite');

      const labelSpan = document.createElement('span');
      labelSpan.textContent = timer.label ? timer.label : '(ラベルなし)';
      labelSpan.style.minWidth = '6em';

      const timeSpan = document.createElement('span');
      timeSpan.textContent = formatTimeSec(Math.ceil(timer.remaining));

      const progress = document.createElement('div');
      progress.className = 'timer-progress';
      const bar = document.createElement('div');
      bar.className = 'progress-bar';
      let ratio = timer.duration > 0 ? timer.remaining / timer.duration : 0;
      bar.style.width = `${(ratio * 100).toFixed(1)}%`;
      progress.appendChild(bar);

      const btnStart = document.createElement('button');
      btnStart.textContent = '開始';
      btnStart.disabled = timer.running;
      btnStart.setAttribute('aria-label', `タイマー${timer.label || ''}開始`);

      const btnPause = document.createElement('button');
      btnPause.textContent = '一時停止';
      btnPause.disabled = !timer.running;
      btnPause.setAttribute('aria-label', `タイマー${timer.label || ''}一時停止`);

      const btnCancel = document.createElement('button');
      btnCancel.textContent = 'キャンセル';
      btnCancel.setAttribute('aria-label', `タイマー${timer.label || ''}キャンセル`);

      btnStart.addEventListener('click', () => {
        if (!timer.running) {
          timer.running = true;
          timer.lastUpdate = Date.now();
          saveTimers();
          renderTimers();
        }
      });
      btnPause.addEventListener('click', () => {
        if (timer.running) {
          timer.running = false;
          saveTimers();
          renderTimers();
        }
      });
      btnCancel.addEventListener('click', () => {
        timers.splice(i,1);
        saveTimers();
        renderTimers();
      });

      div.appendChild(labelSpan);
      div.appendChild(progress);
      div.appendChild(timeSpan);
      div.appendChild(btnStart);
      div.appendChild(btnPause);
      div.appendChild(btnCancel);
      timersList.appendChild(div);
    });
  }
  function renderTimerHistory() {
    timerHistoryElem.innerHTML = '';
    if (timerHistory.length === 0) {
      timerHistoryElem.textContent = '履歴はありません。';
      return;
    }
    timerHistory.forEach(h => {
      const d = new Date(h.time);
      const div = document.createElement('div');
      div.textContent = `${d.toLocaleString()} - ${h.label || '(ラベルなし)'}`;
      timerHistoryElem.appendChild(div);
    });
  }
  function clearAllTimersAndHistory() {
    if (confirm('全てのタイマーと履歴を削除しますか？')) {
      timers = [];
      timerHistory = [];
      saveTimers();
      saveTimerHistory();
      renderTimers();
      renderTimerHistory();
    }
  }
  timerForm.addEventListener('submit', e => {
    e.preventDefault();
    const label = timerLabelInput.value.trim();
    const min = parseInt(timerMinutesInput.value, 10);
    const sec = parseInt(timerSecondsInput.value, 10);
    if (isNaN(min) || min < 0 || isNaN(sec) || sec < 0 || sec > 59) {
      alert('正しい時間を入力してください。');
      return;
    }
    const duration = min * 60 + sec;
    if (duration <= 0) {
      alert('1秒以上の時間を設定してください。');
      return;
    }
    timers.push({
      label,
      duration,
      remaining: duration,
      running: true,
      lastUpdate: Date.now(),
      triggered: false
    });
    saveTimers();
    renderTimers();
    timerLabelInput.value = '';
    timerMinutesInput.value = '0';
    timerSecondsInput.value = '10';

    // 通知許可を求める (まだなら)
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
  });

  // --- アラーム機能 ---
  let alarms = JSON.parse(localStorage.getItem('alarms') || '[]');
  const alarmForm = document.getElementById('alarmForm');
  const alarmHourInput = document.getElementById('alarmHour');
  const alarmMinuteInput = document.getElementById('alarmMinute');
  const alarmSecondInput = document.getElementById('alarmSecond');
  const alarmLabelInput = document.getElementById('alarmLabel');
  const alarmList = document.getElementById('alarmList');

  function saveAlarms() {
    localStorage.setItem('alarms', JSON.stringify(alarms));
  }

  function renderAlarms() {
    alarmList.innerHTML = '';
    if (alarms.length === 0) {
      alarmList.textContent = 'アラームはありません。';
      return;
    }
    alarms.forEach((a,i) => {
      const div = document.createElement('div');
      div.className = 'alarm-item';
      const labelSpan = document.createElement('span');
      labelSpan.textContent = `${a.label || '(ラベルなし)'} ${padZero(a.hour)}:${padZero(a.minute)}:${padZero(a.second)}`;
      const btnDelete = document.createElement('button');
      btnDelete.textContent = '削除';
      btnDelete.setAttribute('aria-label', `アラーム${a.label || ''}削除`);
      btnDelete.addEventListener('click', () => {
        alarms.splice(i, 1);
        saveAlarms();
        renderAlarms();
      });
      div.appendChild(labelSpan);
      div.appendChild(btnDelete);
      alarmList.appendChild(div);
    });
  }

  function clearAllAlarms() {
    if(confirm('全てのアラームを削除しますか？')){
      alarms = [];
      saveAlarms();
      renderAlarms();
    }
  }

  alarmForm.addEventListener('submit', e => {
    e.preventDefault();
    let h = parseInt(alarmHourInput.value, 10);
    let m = parseInt(alarmMinuteInput.value, 10);
    let s = parseInt(alarmSecondInput.value, 10);
    if (
      isNaN(h) || h < 0 || h > 23 ||
      isNaN(m) || m < 0 || m > 59 ||
      isNaN(s) || s < 0 || s > 59
    ) {
      alert('正しい時刻を入力してください。');
      return;
    }
    const label = alarmLabelInput.value.trim();
    alarms.push({hour: h, minute: m, second: s, label, triggered: false});
    saveAlarms();
    renderAlarms();
    alarmHourInput.value = '';
    alarmMinuteInput.value = '';
    alarmSecondInput.value = '0';
    alarmLabelInput.value = '';
    showTab('alarm');

    // 通知許可を求める (まだなら)
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
  });

  function checkAlarms() {
    const now = new Date();
    alarms.forEach(a => {
      if (!a.triggered && a.hour === now.getHours() && a.minute === now.getMinutes() && a.second === now.getSeconds()) {
        a.triggered = true;
        saveAlarms();
        // 通知関数を呼び出す
        showNotification(
          `アラーム: ${a.label || ''}`,
          `${padZero(a.hour)}:${padZero(a.minute)}:${padZero(a.second)} です。`,
          alarmAudio
        );
      }
      if(a.triggered){
        if (now.getHours() !== a.hour || now.getMinutes() !== a.minute || now.getSeconds() !== a.second) {
          a.triggered = false;
          saveAlarms();
        }
      }
    });
  }
  renderAlarms();

  // --- ストップウォッチ ---
  let stopwatch = {
    running: false,
    startTimestamp: 0,
    elapsedBeforeStart: 0,
    laps: []
  };

  const stopwatchDisplay = document.getElementById('stopwatchDisplay');
  const startStopwatchBtn = document.getElementById('startStopwatchBtn');
  const pauseStopwatchBtn = document.getElementById('pauseStopwatchBtn');
  const resetStopwatchBtn = document.getElementById('resetStopwatchBtn');
  const lapStopwatchBtn = document.getElementById('lapStopwatchBtn');
  const lapList = document.getElementById('lapList');

  function formatStopwatchTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const msRemain = ms % 1000;
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${msRemain.toString().padStart(3,'0')}`;
  }

  function updateStopwatchDisplay() {
    let elapsed;
    if (stopwatch.running) {
      elapsed = stopwatch.elapsedBeforeStart + (Date.now() - stopwatch.startTimestamp);
    } else {
      elapsed = stopwatch.elapsedBeforeStart;
    }
    stopwatchDisplay.textContent = formatStopwatchTime(elapsed);
  }

  function renderLaps() {
    lapList.innerHTML = '';
    if (stopwatch.laps.length === 0) {
      lapList.textContent = 'ラップタイムはありません。';
      return;
    }
    stopwatch.laps.forEach((lap, i) => {
      const div = document.createElement('div');
      div.className = 'lap-item';
      div.textContent = `Lap ${i + 1}: ${formatStopwatchTime(lap)}`;
      lapList.appendChild(div);
    });
  }

  function startStopwatch() {
    if (!stopwatch.running) {
      stopwatch.running = true;
      stopwatch.startTimestamp = Date.now();
      startStopwatchBtn.disabled = true;
      pauseStopwatchBtn.disabled = false;
      resetStopwatchBtn.disabled = false;
      lapStopwatchBtn.disabled = false;
    }
  }

  function pauseStopwatch() {
    if (stopwatch.running) {
      stopwatch.running = false;
      stopwatch.elapsedBeforeStart += (Date.now() - stopwatch.startTimestamp);
      startStopwatchBtn.disabled = false;
      pauseStopwatchBtn.disabled = true;
      lapStopwatchBtn.disabled = true;
    }
  }

  function resetStopwatch() {
    stopwatch.running = false;
    stopwatch.elapsedBeforeStart = 0;
    stopwatch.startTimestamp = 0;
    stopwatch.laps = [];
    startStopwatchBtn.disabled = false;
    pauseStopwatchBtn.disabled = true;
    resetStopwatchBtn.disabled = true;
    lapStopwatchBtn.disabled = true;
    updateStopwatchDisplay();
    renderLaps();
  }

  function lapStopwatch() {
    if (stopwatch.running) {
      let elapsed = stopwatch.elapsedBeforeStart + (Date.now() - stopwatch.startTimestamp);
      stopwatch.laps.unshift(elapsed);
      renderLaps();
    }
  }

  startStopwatchBtn.addEventListener('click', startStopwatch);
  pauseStopwatchBtn.addEventListener('click', pauseStopwatch);
  resetStopwatchBtn.addEventListener('click', resetStopwatch);
  lapStopwatchBtn.addEventListener('click', lapStopwatch);

  resetStopwatch();

  setInterval(() => {
    if (stopwatch.running) {
      updateStopwatchDisplay();
    }
  }, 16);

  // --- タイマー動作ループ ---
  function tickTimers() {
    const now = Date.now();
    let updated = false;
    timers.forEach(timer => {
      if (timer.running) {
        const elapsed = (now - timer.lastUpdate) / 1000;
        if (elapsed >= 0.2) { // 0.2秒未満の更新は無視し処理負荷軽減
          timer.remaining -= elapsed;
          if (timer.remaining <= 0 && !timer.triggered) {
            timer.remaining = 0;
            timer.running = false;
            timer.triggered = true;
            timerHistory.unshift({label: timer.label, time: now});
            saveTimerHistory();
            renderTimerHistory();
            
            // 通知関数を呼び出す
            showNotification(
              `タイマー終了: ${timer.label || ''}`,
              '時間が経過しました。',
              timerAudio
            );
          }
          timer.lastUpdate = now;
          updated = true;
        }
      }
    });
    if(updated){
      saveTimers();
      renderTimers();
    }
  }
  renderTimers();
  renderTimerHistory();

  setInterval(() => {
    tickTimers();
    checkAlarms();
  }, 250);

  // --- 設定タブの履歴全削除ボタン ---
  const clearAllHistoryBtn = document.getElementById('clearAllHistoryBtn');
  clearAllHistoryBtn.addEventListener('click', () => {
    if(confirm('全てのタイマー、履歴、アラームを削除しますか？')){
      timers = [];
      timerHistory = [];
      alarms = [];
      saveTimers();
      saveTimerHistory();
      saveAlarms();
      renderTimers();
      renderTimerHistory();
      renderAlarms();
      alert('全て削除しました。');
    }
  });

  // --- PWA インストール機能の追加 ---
  let deferredInstallPrompt = null;
  const installPwaBtn = document.getElementById('installPwaBtn');

  // 1. ブラウザがインストール可能と判断したとき (イベント捕捉)
  window.addEventListener('beforeinstallprompt', (e) => {
    // ブラウザのデフォルトプロンプト表示を抑制
    e.preventDefault();
    // 後で使うためにイベントオブジェクトを保存
    deferredInstallPrompt = e;
    // ボタンを有効にする
    installPwaBtn.disabled = false;
    return false;
  });

  // 2. インストールボタンがクリックされたとき (プロンプト表示)
  installPwaBtn.addEventListener('click', () => {
    if (deferredInstallPrompt) {
      // ボタンを一時的に無効にし、ユーザー操作を待つ
      installPwaBtn.disabled = true;
      
      // 保存したイベントオブジェクトを使ってプロンプトを表示
      deferredInstallPrompt.prompt();

      // ユーザーの応答を待ち受ける
      deferredInstallPrompt.userChoice.then((choiceResult) => {
        console.log('User choice:', choiceResult.outcome);
        
        // ユーザーがインストールを選択しなかった場合
        if (choiceResult.outcome === 'dismissed') {
          console.log('PWA installation dismissed.');
          // 再度インストールできる可能性があるため、プロンプトを再設定
          deferredInstallPrompt = null; 
          installPwaBtn.disabled = false; // ボタンを再有効化
        } else {
          // ユーザーがインストールを選択した場合
          console.log('PWA installed successfully.');
          deferredInstallPrompt = null;
          installPwaBtn.textContent = 'インストール済み';
        }
      });
    }
  });

  // 3. アプリがインストールされたとき (ボタン非表示/状態変更)
  window.addEventListener('appinstalled', (e) => {
    installPwaBtn.disabled = true;
    installPwaBtn.textContent = 'インストール済み';
    // deferredInstallPrompt が不要になったのでクリア
    deferredInstallPrompt = null;
  });
  // --- /PWA インストール機能の追加 ---

})();
</script>
</body>
</html>
