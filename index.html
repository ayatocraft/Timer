<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Full Clock Tool</title>
<style>
  /* --- スタイルは元のコードと同じ --- */
  * { box-sizing: border-box; }
  body { margin:0; padding:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:#fff; color:#000; display:flex; height:100vh; overflow:hidden; }
  body.dark { background:#121212; color:#fff; }
  button { cursor:pointer; font-family:inherit; font-size:1rem; }
  button:disabled { opacity:0.5; cursor:default; }
  nav.tabs { display:flex; flex-direction:column; background:#f0f0f0; border-right:1px solid #ccc; width:240px; transition:width 0.3s ease; }
  body.dark nav.tabs { background:#222; border-color:#444; }
  nav.tabs.hidden { display:none; }
  nav.tabs button.tab { background:none; border:none; padding:1rem 1.5rem; text-align:left; border-bottom:1px solid #ccc; color:inherit; }
  body.dark nav.tabs button.tab { border-color:#444; }
  nav.tabs button.tab.active { background:#0078d7; color:white; font-weight:bold; }
  nav.tabs button.tab:focus-visible { outline:2px solid #0078d7; }
  header { display:flex; align-items:center; justify-content:space-between; padding:0 1rem; height:44px; background:#0078d7; color:#fff; flex-shrink:0; }
  #toggleTabsBtn { background:none; border:none; font-size:1.6rem; color:white; }
  #toggleTabsBtn:focus-visible { outline:2px solid #fff; }
  main { flex-grow:1; overflow-y:auto; padding:1rem; }
  section.content { display:none; }
  section.content.active { display:block; }
  h1 { margin-top:0; }
  #dateTimeWrapper { font-weight:bold; color:inherit; flex-grow:1; text-align:center; user-select:none; }
  #currentTime, #currentDate { line-height:1.2; }
  #currentTime { font-size:1.8rem; }
  #currentDate { font-size:1.2rem; opacity:0.8; }
  .input-group { margin:0.5rem 0; display:flex; gap:0.5rem; flex-wrap:wrap; }
  input[type=number], input[type=text], textarea, select { font-family:inherit; font-size:1rem; padding:0.3rem 0.5rem; border:1px solid #ccc; border-radius:3px; flex-grow:1; }
  body.dark input[type=number], body.dark input[type=text], body.dark textarea, body.dark select { background:#222; border-color:#555; color:#eee; }
  textarea { resize:vertical; min-height:6rem; }
  label { font-weight:normal; user-select:none; }
  #timersList, #timerHistory, #alarmList, #lapList { margin-top:0.5rem; max-height:250px; overflow-y:auto; border:1px solid #ccc; border-radius:4px; padding:0.5rem; background:#fafafa; color:#000; }
  body.dark #timersList, body.dark #timerHistory, body.dark #alarmList, body.dark #lapList { background:#222; border-color:#444; color:#fff; }
  .timer-item, .alarm-item, .lap-item { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.3rem; padding:0.3rem; border-bottom:1px solid #ddd; }
  body.dark .timer-item, body.dark .alarm-item, body.dark .lap-item { border-color:#444; }
  .timer-item:last-child, .alarm-item:last-child, .lap-item:last-child { border-bottom:none; }
  .timer-item span, .alarm-item span { flex-shrink:0; }
  .timer-controls button, .alarm-item button { margin-left:0.3rem; }
  .timer-progress { flex-grow:1; margin:0 0.5rem; background:#ddd; border-radius:3px; height:12px; overflow:hidden; }
  body.dark .timer-progress { background:#444; }
  .progress-bar { background:#0078d7; height:100%; transition:width 0.4s linear; }
  #stopwatchDisplay { font-size:2rem; font-weight:bold; text-align:center; margin-bottom:0.5rem; }
  [tabindex="0"]:focus { outline:2px solid #0078d7; }
</style>
</head>
<body>
<nav class="tabs" aria-label="メインナビゲーション">
  <button id="tab-home" class="tab active" role="tab" aria-selected="true" tabindex="0">ホーム</button>
  <button id="tab-timer" class="tab" role="tab" aria-selected="false" tabindex="-1">タイマー</button>
  <button id="tab-alarm" class="tab" role="tab" aria-selected="false" tabindex="-1">アラーム</button>
  <button id="tab-stopwatch" class="tab" role="tab" aria-selected="false" tabindex="-1">ストップウォッチ</button>
  <button id="tab-settings" class="tab" role="tab" aria-selected="false" tabindex="-1">設定</button>
</nav>

<div style="flex-grow:1; display:flex; flex-direction:column;">
<header>
  <button id="toggleTabsBtn" aria-label="タブの表示切替" aria-expanded="true">≡</button>
  <div id="dateTimeWrapper" aria-live="polite" aria-atomic="true"></div>
</header>

<main>
  <section id="home" class="content active" role="tabpanel" aria-labelledby="tab-home" tabindex="0">
    <h1>ホーム</h1>
    <div id="currentTime" aria-label="現在時刻"></div>
    <div id="currentDate" aria-label="現在日付"></div>
  </section>

  <section id="timer" class="content" role="tabpanel" aria-labelledby="tab-timer" tabindex="-1">
    <h1>タイマー</h1>
    <form id="timerForm" aria-label="タイマー追加フォーム">
      <div class="input-group">
        <input type="text" id="timerLabel" placeholder="ラベル（任意）" aria-label="タイマーラベル" />
      </div>
      <div class="input-group" style="gap: 0.2rem;">
        <label for="timerMinutes">分</label>
        <input type="number" id="timerMinutes" min="0" max="999" value="0" aria-label="分" />
        <label for="timerSeconds">秒</label>
        <input type="number" id="timerSeconds" min="0" max="59" value="10" aria-label="秒" />
      </div>
      <div class="input-group">
        <button type="submit">追加して開始</button>
      </div>
    </form>
    <div id="timersList" aria-live="polite" aria-atomic="true"></div>
    <h2>タイマー履歴</h2>
    <div id="timerHistory" aria-live="polite" aria-atomic="true" tabindex="0"></div>
  </section>
</main>
</div>

<audio id="timerAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg" />
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.mp3" type="audio/mpeg" />
</audio>

<script>
(() => {
  // --- タブ管理 & 日付 ---
  const tabs = document.querySelectorAll('nav.tabs button.tab');
  const contents = document.querySelectorAll('main section.content');
  const toggleTabsBtn = document.getElementById('toggleTabsBtn');
  const navTabs = document.querySelector('nav.tabs');
  const dateTimeWrapper = document.getElementById('dateTimeWrapper');
  const currentTimeElem = document.getElementById('currentTime');
  const currentDateElem = document.getElementById('currentDate');

  function showTab(id, clickedTab=null){
    contents.forEach(section => { section.classList.toggle('active', section.id===id); section.setAttribute('tabindex', section.id===id?'0':'-1'); });
    tabs.forEach(tab => { const sel = tab.id==='tab-'+id; tab.classList.toggle('active',sel); tab.setAttribute('aria-selected',sel); tab.tabIndex=sel?0:-1; });
    if(clickedTab) clickedTab.focus();
  }
  tabs.forEach(tab=>{
    tab.addEventListener('click',()=>showTab(tab.id.replace('tab-',''),tab));
    tab.addEventListener('keydown',e=>{
      let idx=Array.from(tabs).indexOf(e.target);
      if(e.key==='ArrowRight'){e.preventDefault(); tabs[(idx+1)%tabs.length].focus();}
      else if(e.key==='ArrowLeft'){e.preventDefault(); tabs[(idx-1+tabs.length)%tabs.length].focus();}
    });
  });
  let tabsVisible = true;
  toggleTabsBtn.addEventListener('click',()=>{
    tabsVisible=!tabsVisible;
    navTabs.classList.toggle('hidden',!tabsVisible);
    toggleTabsBtn.setAttribute('aria-expanded', tabsVisible);
  });

  const WEEK_DAYS_JP=['日','月','火','水','木','金','土'];
  function padZero(n,len=2){return String(n).padStart(len,'0');}
  function updateDateTime(){const now=new Date(); currentTimeElem.textContent=`${padZero(now.getHours())}:${padZero(now.getMinutes())}:${padZero(now.getSeconds())}`; currentDateElem.textContent=`${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日（${WEEK_DAYS_JP[now.getDay()]}）`;}
  updateDateTime(); setInterval(updateDateTime,1000);

  // --- タイマー機能 ---
  let timers = JSON.parse(localStorage.getItem('timers')||'[]');
  let timerHistory = JSON.parse(localStorage.getItem('timerHistory')||'[]');

  const timerForm=document.getElementById('timerForm');
  const timerLabelInput=document.getElementById('timerLabel');
  const timerMinutesInput=document.getElementById('timerMinutes');
  const timerSecondsInput=document.getElementById('timerSeconds');
  const timersList=document.getElementById('timersList');
  const timerAudio=document.getElementById('timerAudio');
  const timerHistoryElem=document.getElementById('timerHistory');

  function saveTimers(){localStorage.setItem('timers',JSON.stringify(timers));}
  function saveTimerHistory(){localStorage.setItem('timerHistory',JSON.stringify(timerHistory));}
  function formatTimeSec(s){const m=Math.floor(s/60); const sec=s%60; return `${m}分${sec}秒`;}
  function showNotification(title,msg){
    if(!("Notification" in window)) return alert(msg);
    if(Notification.permission==="granted"){new Notification(title,{body:msg});}
    else if(Notification.permission!=="denied"){Notification.requestPermission().then(p=>{if(p==="granted") new Notification(title,{body:msg});});}
    else{alert(msg);}
  }
  function renderTimers(){
    timersList.innerHTML='';
    if(timers.length===0){timersList.textContent='タイマーはありません。'; return;}
    timers.forEach((timer,i)=>{
      const div=document.createElement('div'); div.className='timer-item';
      const labelSpan=document.createElement('span'); labelSpan.textContent=timer.label||'(ラベルなし)'; labelSpan.style.minWidth='6em';
      const timeSpan=document.createElement('span'); timeSpan.textContent=formatTimeSec(Math.ceil(timer.remaining));
      const progress=document.createElement('div'); progress.className='timer-progress';
      const bar=document.createElement('div'); bar.className='progress-bar'; bar.style.width=`${(timer.duration>0?timer.remaining/timer.duration:0)*100}%`; progress.appendChild(bar);
      const btnStart=document.createElement('button'); btnStart.textContent='開始'; btnStart.disabled=timer.running;
      const btnPause=document.createElement('button'); btnPause.textContent='一時停止'; btnPause.disabled=!timer.running;
      const btnCancel=document.createElement('button'); btnCancel.textContent='キャンセル';
      btnStart.addEventListener('click',()=>{if(!timer.running){timer.running=true; timer.lastUpdate=Date.now(); saveTimers(); renderTimers();}});
      btnPause.addEventListener('click',()=>{if(timer.running){timer.running=false; saveTimers(); renderTimers();}});
      btnCancel.addEventListener('click',()=>{timers.splice(i,1); saveTimers(); renderTimers();});
      div.appendChild(labelSpan); div.appendChild(progress); div.appendChild(timeSpan); div.appendChild(btnStart); div.appendChild(btnPause); div.appendChild(btnCancel);
      timersList.appendChild(div);
    });
  }
  function renderTimerHistory(){
    timerHistoryElem.innerHTML='';
    if(timerHistory.length===0){timerHistoryElem.textContent='履歴はありません。'; return;}
    timerHistory.forEach(h=>{const d=new Date(h.time); const div=document.createElement('div'); div.textContent=`${d.toLocaleString()} - ${h.label||'(ラベルなし)'}`; timerHistoryElem.appendChild(div);});
  }

  timerForm.addEventListener('submit',e=>{
    e.preventDefault();
    const label=timerLabelInput.value.trim();
    const min=parseInt(timerMinutesInput.value,10);
    const sec=parseInt(timerSecondsInput.value,10);
    if(isNaN(min)||min<0||isNaN(sec)||sec<0||sec>59){alert('正しい時間を入力してください。'); return;}
    const duration=min*60+sec;
    if(duration<=0){alert('1秒以上の時間を設定してください。'); return;}
    timers.push({label,duration,remaining:duration,running:true,lastUpdate:Date.now(),triggered:false});
    saveTimers(); renderTimers();
    timerLabelInput.value=''; timerMinutesInput.value='0'; timerSecondsInput.value='10';
  });

  function tickTimers(){
    const now=Date.now(); let updated=false;
    timers.forEach(timer=>{
      if(timer.running){
        const elapsed=(now-timer.lastUpdate)/1000;
        if(elapsed>=0.2){
          timer.remaining-=elapsed;
          if(timer.remaining<=0&&!timer.triggered){
            timer.remaining=0; timer.running=false; timer.triggered=true;
            timerHistory.unshift({label:timer.label,time:now}); saveTimerHistory(); renderTimerHistory();
            if(timerAudio.src) timerAudio.play().catch(()=>{});
            showNotification('タイマー終了', `タイマー: ${timer.label||'(ラベルなし)'} が終了しました`);
          }
          timer.lastUpdate=now; updated=true;
        }
      }
    });
    if(updated){ saveTimers(); renderTimers(); }
  }

  renderTimers(); renderTimerHistory();
  setInterval(tickTimers,250);
})();
</script>
</body>
</html>
